<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTG Tribal Break Calculator & Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-card: #1c2128;
  --bg-input: #21262d;
  --bg-hover: #30363d;
  --border: #30363d;
  --border-focus: #58a6ff;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --accent: #58a6ff;
  --accent-hover: #79c0ff;
  --accent-bg: rgba(88, 166, 255, 0.1);
  --success: #3fb950;
  --success-bg: rgba(63, 185, 80, 0.1);
  --warning: #d29922;
  --warning-bg: rgba(210, 153, 34, 0.1);
  --danger: #f85149;
  --danger-bg: rgba(248, 81, 73, 0.1);
  --gold: #f0c040;
  --mythic: #e86020;
  --rare: #c8a84e;
  --uncommon: #a0a8b0;
  --common: #555;
  --radius: 8px;
  --radius-sm: 4px;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --transition: 0.2s ease;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; min-height: 100vh; }
a { color: var(--accent); text-decoration: none; }
a:hover { color: var(--accent-hover); text-decoration: underline; }
.app-header { background: linear-gradient(135deg, #1a1e2e 0%, #0d1117 100%); border-bottom: 1px solid var(--border); padding: 1.5rem 2rem; text-align: center; }
.header-content h1 { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.02em; background: linear-gradient(135deg, var(--accent), #a371f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.header-content .icon { font-size: 1.5rem; }
.subtitle { color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.25rem; }
.app-main { max-width: 1100px; margin: 0 auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.card-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
.card-header h2 { font-size: 1.15rem; font-weight: 600; }
.card-body { padding: 1.25rem; }
.help-tip { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; background: var(--bg-hover); color: var(--text-secondary); font-size: 0.75rem; font-weight: 700; cursor: help; transition: all var(--transition); }
.help-tip:hover { background: var(--accent-bg); color: var(--accent); }
.btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-hover); color: var(--text-primary); font-family: var(--font); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all var(--transition); white-space: nowrap; }
.btn:hover:not(:disabled) { background: #3a424b; border-color: #484f58; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-primary { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); }
.btn-accent { background: linear-gradient(135deg, #a371f7, #58a6ff); border: none; color: #fff; font-weight: 600; }
.btn-accent:hover:not(:disabled) { filter: brightness(1.1); }
.btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
.btn-danger { color: var(--danger); }
.btn-danger:hover:not(:disabled) { background: var(--danger-bg); border-color: var(--danger); }
input[type="text"], input[type="number"], select, textarea { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: var(--font); font-size: 0.875rem; padding: 0.5rem 0.75rem; transition: border-color var(--transition); width: 100%; }
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15); }
select:disabled { opacity: 0.5; cursor: not-allowed; }
.small-input { width: 80px; }
label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }
.input-group { display: flex; flex-direction: column; }
.roster-input-row { display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 1rem; }
.roster-input-row .input-group:nth-child(1) { flex: 0 0 70px; }
.roster-input-row .input-group:nth-child(2) { flex: 1; min-width: 200px; }
.roster-input-row .input-group:nth-child(3) { flex: 0 0 180px; }
.set-autocomplete-wrapper { position: relative; }
.suggestions-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-sm); max-height: 260px; overflow-y: auto; box-shadow: var(--shadow); }
.suggestions-dropdown.hidden { display: none; }
.suggestion-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
.suggestion-item:last-child { border-bottom: none; }
.suggestion-item:hover, .suggestion-item.active { background: var(--accent-bg); color: var(--accent); }
.suggestion-code { color: var(--text-muted); font-family: monospace; font-size: 0.8rem; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th { text-align: left; padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.data-table td { padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
.data-table tr:hover td { background: rgba(255, 255, 255, 0.02); }
.status-badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; font-weight: 500; }
.status-cached { background: var(--success-bg); color: var(--success); }
.status-loading { background: var(--warning-bg); color: var(--warning); }
.status-error { background: var(--danger-bg); color: var(--danger); }
.empty-state { text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem; }
.roster-summary { display: flex; gap: 1.5rem; padding: 0.75rem 0 0; font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
.mode-toggle { display: flex; gap: 0.25rem; background: var(--bg-input); border-radius: var(--radius-sm); padding: 2px; }
.mode-toggle .btn-sm.active { background: var(--accent); color: #000; border-color: var(--accent); }
.manual-controls { display: flex; gap: 0.75rem; align-items: flex-end; margin-bottom: 1rem; }
.manual-controls .input-group { flex: 1; }
.mass-entry-wrapper { margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border); }
.mass-entry-wrapper label { margin-bottom: 0.4rem; }
.mass-entry-wrapper textarea { margin-bottom: 0.5rem; resize: vertical; }
.spots-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.25rem; }
.spot-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.875rem; cursor: grab; }
.spot-item:active { cursor: grabbing; }
.spot-number { font-weight: 700; color: var(--text-muted); font-size: 0.75rem; min-width: 28px; }
.spot-label { flex: 1; font-weight: 500; }
.spot-ev { color: var(--success); font-weight: 600; font-family: monospace; min-width: 60px; text-align: right; }
.spot-actions { display: flex; gap: 0.25rem; }
.spot-actions .btn { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
.spots-summary { display: flex; gap: 1rem; align-items: center; padding: 0.75rem 0 0; font-size: 0.85rem; color: var(--text-secondary); }
.spot-note { font-size: 0.75rem; color: var(--text-muted); }
.insurance-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border); }
.insurance-row label { margin: 0; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); white-space: nowrap; }
.insurance-row .small-input { width: 90px; }
.ev-controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
.ev-display { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
.ev-card { flex: 1; padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); text-align: center; }
.ev-card.highlight { border-color: var(--accent); background: var(--accent-bg); }
.ev-label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }
.ev-value { display: block; font-size: 1.75rem; font-weight: 700; font-family: monospace; color: var(--success); }
.ev-card.highlight .ev-value { color: var(--accent); }
.sim-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem; }
.sim-spot-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.sim-spot-header { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); background: var(--bg-input); }
.sim-spot-name { font-weight: 600; font-size: 0.9rem; }
.sim-spot-value { font-weight: 700; font-family: monospace; color: var(--success); }
.sim-spot-value.insured { color: var(--warning); }
.sim-spot-cards { padding: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.35rem; max-height: 200px; overflow-y: auto; }
.sim-card-chip { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.2rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; border: 1px solid var(--border); background: var(--bg-input); }
.sim-card-chip.rarity-mythic { border-color: var(--mythic); color: var(--mythic); }
.sim-card-chip.rarity-rare { border-color: var(--rare); color: var(--rare); }
.sim-card-chip.rarity-uncommon { border-color: var(--uncommon); }
.sim-card-chip.rarity-common { border-color: var(--common); }
.sim-card-price { font-family: monospace; font-weight: 600; }
.sim-top-hits { display: flex; gap: 0.5rem; padding: 0.5rem; overflow-x: auto; }
#loading-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
#loading-overlay.hidden { display: none; }
.spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
@keyframes spin { to { transform: rotate(360deg); } }
#loading-text { color: var(--text-secondary); font-size: 0.95rem; }
#toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
.toast { padding: 0.6rem 1rem; border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 500; box-shadow: var(--shadow); animation: slideIn 0.3s ease; max-width: 360px; }
.toast-success { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }
.toast-error { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger); }
.toast-info { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.app-footer { text-align: center; padding: 1.5rem; color: var(--text-muted); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 2rem; }
.app-footer p + p { margin-top: 0.25rem; }
.hidden { display: none !important; }
@media (max-width: 640px) {
  .app-header { padding: 1rem; }
  .header-content h1 { font-size: 1.2rem; }
  .subtitle { font-size: 0.8rem; }
  .app-main { padding: 0.75rem; gap: 1rem; }
  .card-header { flex-wrap: wrap; gap: 0.4rem; }
  .card-header h2 { font-size: 1rem; }
  .roster-input-row { flex-direction: column; }
  .roster-input-row .input-group { flex: 1 1 100% !important; }
  .data-table { font-size: 0.75rem; }
  .data-table th, .data-table td { padding: 0.35rem 0.4rem; }
  /* Hide less critical table columns on small screens */
  .data-table th:nth-child(4), .data-table td:nth-child(4) { display: none; }
  .mode-toggle { flex-wrap: wrap; }
  .manual-controls { flex-direction: column; }
  .insurance-row { flex-wrap: wrap; }
  .ev-display { flex-direction: column; }
  .ev-card { padding: 0.75rem 1rem; }
  .ev-value { font-size: 1.6rem; }
  .sim-grid { grid-template-columns: 1fr; }
  .modal-box { width: 95%; max-height: 90vh; }
  .btn { font-size: 0.8rem; padding: 0.45rem 0.75rem; }
  #spot-count-label { display: none; }
  .card-header > h2 { flex: 1; }
}
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
.spot-item.drag-over { border-color: var(--accent); background: var(--accent-bg); }
.spot-item.spot-bulk { background: var(--bg-input); border-style: dashed; opacity: 0.7; }
.spot-item.spot-last { background: var(--warning-bg); border-color: var(--warning); }

/* Expandable type rows */
.type-row { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 0.25rem; overflow: hidden; }
.type-row-header { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; transition: background var(--transition); user-select: none; }
.type-row-header:hover { background: rgba(255,255,255,0.03); }
.type-row-toggle { font-size: 0.7rem; color: var(--text-muted); transition: transform var(--transition); width: 16px; text-align: center; }
.type-row.expanded .type-row-toggle { transform: rotate(90deg); }
.type-row-name { flex: 1; font-weight: 500; font-size: 0.875rem; }
.type-row-count { color: var(--text-muted); font-size: 0.8rem; min-width: 60px; }
.type-row-ev { color: var(--success); font-weight: 600; font-family: monospace; font-size: 0.875rem; min-width: 70px; text-align: right; }
.type-row-cards { display: none; padding: 0 0.75rem 0.5rem; }
.type-row.expanded .type-row-cards { display: block; }
.card-detail-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.2rem 0; font-size: 0.8rem; border-bottom: 1px solid rgba(48,54,61,0.5); }
.card-detail-row:last-child { border-bottom: none; }
.card-detail-name { flex: 1; }
.card-detail-rarity { font-size: 0.7rem; text-transform: uppercase; min-width: 50px; }
.card-detail-rarity.r-mythic { color: var(--mythic); }
.card-detail-rarity.r-rare { color: var(--rare); }
.card-detail-price { font-family: monospace; color: var(--text-secondary); min-width: 110px; text-align: right; }
.card-print-price { cursor: pointer; border-bottom: 1px dotted transparent; transition: color 0.2s ease, border-color 0.2s ease; }
.card-print-price:hover { color: var(--accent); border-bottom-color: var(--accent); }
.card-detail-ev { font-family: monospace; color: var(--success); font-weight: 600; min-width: 65px; text-align: right; }
.type-row-actions { display: flex; gap: 0.25rem; margin-left: 0.5rem; }

/* Card name links in expanded rows */
.card-name-link { color: inherit; text-decoration: none; border-bottom: 1px dotted var(--text-muted); transition: color var(--transition), border-color var(--transition); }
.card-name-link:hover { color: var(--accent); border-bottom-color: var(--accent); text-decoration: none; }

/* Category section headers */
.cat-section { margin-bottom: 0.75rem; }
.cat-section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.cat-section-title { font-size: 1rem; font-weight: 600; }
.cat-section-badge { font-size: 0.75rem; color: var(--text-muted); background: var(--bg-input); padding: 0.15rem 0.5rem; border-radius: 10px; }

/* Breakout sub-rows */
.breakout-row { margin-left: 1.5rem; }
.breakout-row .type-row-header { padding-left: 0.5rem; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; display: flex; align-items: center; justify-content: center; }
.modal-overlay.hidden { display: none; }
.modal-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); max-width: 640px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
.modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
.modal-header h3 { font-size: 1.1rem; font-weight: 600; }
.modal-body { padding: 1.25rem; font-size: 0.875rem; line-height: 1.7; color: var(--text-secondary); }
.modal-body h4 { color: var(--text-primary); font-size: 0.95rem; margin: 1rem 0 0.4rem; }
.modal-body h4:first-child { margin-top: 0; }
.modal-body p { margin-bottom: 0.5rem; }
.modal-body code { background: var(--bg-input); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.8rem; color: var(--accent); }
.modal-body table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; font-size: 0.8rem; }
.modal-body th, .modal-body td { padding: 0.35rem 0.5rem; border: 1px solid var(--border); text-align: left; }
.modal-body th { background: var(--bg-input); color: var(--text-primary); font-weight: 600; }
</style>
</head>
<body>
  <header class="app-header">
    <div class="header-content">
      <h1><span class="icon">&#9876;</span> MTG Tribal Break Calculator <span class="help-tip" id="what-is-tribal-btn" title="What is a Tribal Break?" style="-webkit-text-fill-color:initial;font-size:0.7rem;vertical-align:middle;margin-left:0.25rem">?</span></h1>
      <p class="subtitle">Evaluate EV &amp; Simulate Mixed-Pack Breaks</p>
    </div>
  </header>

  <main class="app-main">
    <section id="roster-section" class="card">
      <div class="card-header">
        <h2>&#x1F4E6; Break Roster</h2>
        <span class="help-tip" id="roster-help-tip" title="Add sets and pack types to build your break pool. Data is fetched from Scryfall when you add a row.">?</span>
      </div>
      <div class="card-body">
        <div class="roster-input-row">
          <div class="input-group">
            <label for="roster-qty">Qty</label>
            <input type="number" id="roster-qty" min="1" max="100" value="6" class="small-input">
          </div>
          <div class="input-group set-autocomplete-wrapper">
            <label for="roster-set">Set</label>
            <input type="text" id="roster-set" placeholder="Type set name or code..." autocomplete="off">
            <div id="set-suggestions" class="suggestions-dropdown hidden"></div>
          </div>
          <div class="input-group">
            <label for="roster-pack">Pack Type</label>
            <select id="roster-pack" disabled>
              <option value="">Select a set first</option>
            </select>
          </div>
          <button id="add-roster-btn" class="btn btn-primary" disabled>+ Add to Roster</button>
        </div>
        <div id="roster-table-wrapper">
          <table id="roster-table" class="data-table">
            <thead><tr><th>Qty</th><th>Set</th><th>Pack Type</th><th>Cards (est.)</th><th>Status</th><th></th></tr></thead>
            <tbody id="roster-tbody"></tbody>
          </table>
          <div id="roster-empty" class="empty-state">No packs added yet. Build your break roster above.</div>
        </div>
        <div class="roster-summary">
          <span id="total-packs">Total Packs: 0</span>
          <span id="total-cards-est">Est. Cards: 0</span>
        </div>
      </div>
    </section>

    <section id="spots-section" class="card">
      <div class="card-header">
        <h2>&#x1F3AF; Spot Assignment (<span id="spot-count-label">100</span> Spots)</h2>
        <div style="display:flex;align-items:center;gap:0.5rem">
          <label for="num-spots" style="font-size:0.8rem;color:var(--text-muted);white-space:nowrap"># Spots:</label>
          <input type="number" id="num-spots" min="2" max="500" value="100" class="small-input" style="width:70px">
        </div>
        <div class="mode-toggle">
          <button id="quick-mode-btn" class="btn btn-sm btn-accent active">Quick Mode</button>
          <button id="manual-mode-btn" class="btn btn-sm">Manual Mode</button>
        </div>
      </div>
      <div class="card-body">
        <div id="quick-mode-panel">
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
            <p class="mode-desc" style="margin:0;flex:1">Auto-analyze the Break Roster to find creature tribes and non-creature types with probability-weighted EV per spot.</p>
            <span class="help-tip" id="methodology-btn" title="How is EV calculated?">?</span>
          </div>
          <button id="auto-tabulate-btn" class="btn btn-primary" disabled>&#x26A1; Auto-Tabulate Spots</button>
          <div id="quick-results" class="hidden"></div>
        </div>
        <div id="manual-mode-panel" class="hidden">
          <p class="mode-desc">Define your spots manually. Use tribe names, card types, or color+type combos. AND/OR logic: "Snake/Snail" claims either.</p>
          <div class="manual-controls">
            <div class="input-group">
              <label for="spot-name">Spot Name / Tribe or Type</label>
              <input type="text" id="spot-name" placeholder='e.g. "Eldrazi", "Blue Sorcery", "Equipment"'>
            </div>
            <button id="add-spot-btn" class="btn btn-primary">+ Add Spot</button>
          </div>
          <div class="mass-entry-wrapper">
            <label for="mass-entry">Mass Entry (one per line) &mdash; supports tribes, types, and color+type combos</label>
            <textarea id="mass-entry" rows="5" placeholder='Eldrazi&#10;Human&#10;Snake/Snail&#10;Blue Sorcery&#10;Red Sorcery&#10;Legendary Artifact&#10;Equipment&#10;Aura&#10;Class/Saga/Case'></textarea>
            <button id="parse-mass-btn" class="btn btn-sm">Parse &amp; Add</button>
          </div>
          <div id="spots-list" class="spots-list"></div>
          <div class="spots-summary">
            <span id="spots-count">Spots defined: 0 / 99</span>
            <span class="spot-note">(+1 Bulk spot + Last Spot auto-assigned)</span>
          </div>
        </div>
        <div class="insurance-row">
          <label for="pack-insurance">Pack Insurance Value: $</label>
          <input type="number" id="pack-insurance" min="0" step="0.50" value="5.00" class="small-input">
        </div>
      </div>
    </section>

    <section id="ev-section" class="card">
      <div class="card-header"><h2>&#x1F4B0; EV &amp; Simulation</h2></div>
      <div class="card-body">
        <div class="ev-controls">
          <button id="calc-ev-btn" class="btn btn-primary" disabled>Calculate Global EV</button>
          <button id="simulate-btn" class="btn btn-accent" disabled>&#x1F3B2; Simulate Break</button>
        </div>
        <div id="global-ev-display" class="ev-display hidden">
          <div class="ev-card">
            <span class="ev-label">Total Pool EV</span>
            <span id="total-ev" class="ev-value">$0.00</span>
          </div>
          <div class="ev-card highlight">
            <span class="ev-label" id="per-spot-label">EV Per Spot (&#247;100)</span>
            <span id="per-spot-ev" class="ev-value">$0.00</span>
          </div>
        </div>
        <div id="sim-results" class="hidden">
          <h3>Simulation Results</h3>
          <div id="sim-spots-grid" class="sim-grid"></div>
        </div>
      </div>
    </section>
  </main>

  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p id="loading-text">Loading...</p>
  </div>
  <div id="toast-container"></div>

  <!-- Card hover preview popup -->
  <div id="card-preview-popup" style="position:fixed;display:none;z-index:99999;pointer-events:none;isolation:isolate">
    <img id="card-preview-img" style="width:240px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.8)" src="" alt="">
  </div>

  <!-- Methodology Modal -->
  <div id="methodology-modal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">
        <h3>&#x1F4D6; How EV is Calculated</h3>
        <button id="close-modal-btn" class="btn btn-sm">&times;</button>
      </div>
      <div class="modal-body">
        <h4>Pack Simulation</h4>
        <p>Each pack type is modeled with specific slot compositions based on real pack structures:</p>
        <table>
          <tr><th>Pack Type</th><th>Key Slots</th></tr>
          <tr><td>Play Booster</td><td>6 C, 3 U, 1 R/M (7:1), 2 Wildcard, 1 Foil (any rarity), 1 Land (20% foil)</td></tr>
          <tr><td>Draft Booster</td><td>10 C, 3 U, 1 R/M (7:1), 1 Land (10% foil)</td></tr>
          <tr><td>Set Booster</td><td>3 C, 3 U, 1 R/M, 2 Wildcard (higher R/M), 1 Foil, 1 Art, 1 Land (15% foil)</td></tr>
          <tr><td>Collector Booster</td><td>4 Foil C, 2 Foil U, 1 Foil R/M, 2 R/M, 1 Extended Art R/M, 1 Foil Extended R/M, 2 Premium Foil R/M, 1 Premium Foil, 1 Foil Land</td></tr>
        </table>
        <p>R/M = 87.5% Rare / 12.5% Mythic. Wildcard slots use weighted distributions (Play Booster: 60% C, 25% U, 10% R, 5% M). Foil cards use foil pricing when available — look for the ✨foil tag in simulation results.</p>

        <h4>Bonus Sheet / Special Subset Cards</h4>
        <p>Sets with bonus sheets (e.g. OTJ's The Big Score, TMNT's Pizza Sheet) have an approximately <strong>~3.6% per-pack</strong> chance of a bonus sheet card replacing one common slot. The bonus sheet draw is made once per pack and pulls from all rarities (weighted: 45% C, 30% U, 20% R, 5% M). Bonus cards are tagged ★bonus in simulation results.</p>

        <h4>EV Calculation (Expected Value)</h4>
        <p>For each slot in the pack that can produce Rare/Mythic cards, we calculate:</p>
        <p><code>Card EV = Card Price &times; P(pulling that card in one slot) &times; Num Packs</code></p>
        <p>Where <code>P(specific rare) = P(slot hits rare) &divide; (number of rares in set)</code></p>
        <p>For example, in a Play Booster with 60 rares: the rare/mythic slot gives <code>0.875 / 60 = 1.46%</code> chance per pack. Over 6 packs: <code>$50 rare &times; 0.0875 = $4.38 EV</code>.</p>
        <p>The "Spot EV" shown is the sum of all EV contributions from cards matching that spot type — how much value you'd <em>expect</em> in that spot across all packs opened.</p>

        <h4>Per-Set Pack Logic</h4>
        <p><strong>Murders at Karlov Manor (MKM)</strong>: The 10 rare surveil dual lands occupy the Wildcard slot only, not the regular Rare/Mythic slot. Each wildcard slot has an 8.33% chance (~16.67% per pack) of producing a surveil land. This raises EV compared to standard Play Booster logic.</p>
        <p><strong>Outlaws of Thunder Junction (OTJ)</strong>: The Big Score (30 R/M-only mini-set) can appear in a wildcard slot in ~12.5% of Play Boosters. Breaking News has a separate ~3.6% per-pack bonus sheet chance. Both contributions are modeled separately.</p>
        <p>All other post-MKM Play Booster sets (MH3, BLB, DSK, FDN, etc.) and LTR (Draft/Set/Collector) use standard slot structures.</p>

        <h4>Important Notes</h4>
        <p>Prices from TCGplayer Market via Scryfall. Only R/M cards contribute to spot EV (C/U go to Bulk). Set-specific rarities like surge foils, serialized cards, and headliner slots are not separately modeled — these are very low probability events (&lt;1%) that have minimal impact on expected value calculations.</p>
      </div>
    </div>
  </div>

  <!-- Break Roster help modal -->
  <div id="roster-modal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">
        <h3>&#x1F4E6; Break Roster</h3>
        <button id="close-roster-modal-btn" class="btn btn-sm">&times;</button>
      </div>
      <div class="modal-body">
        <h4>What is the Break Roster?</h4>
        <p>The Break Roster is your pack pool — the full list of booster packs being opened in the break. Add one row per distinct set/pack-type combination (e.g. 6 Final Fantasy Collector Boosters + 6 Final Fantasy Play Boosters). When you hit <strong>Add to Roster</strong>, card data is fetched from Scryfall so pricing and EV calculations are accurate.</p>

        <h4>Pack Types</h4>
        <p><strong>Play Booster</strong> — The standard retail booster sold since early 2024. Contains commons, uncommons, one guaranteed R/M slot, two wildcard slots, one guaranteed foil, and a land. Sets released before Feb 2024 used Draft or Set Boosters instead.</p>
        <p><strong>Collector Booster</strong> — Premium booster containing foil, extended-art, borderless, and surge-foil versions of cards. Higher EV per pack but significantly higher cost. The tool models treatment-specific slots (foil R/M, extended art, borderless, premium foil).</p>
        <p><strong>Draft / Set Booster</strong> — Pre-2024 formats. Draft Boosters are the classic 15-card pack. Set Boosters have higher R/M odds and often include an art card. Both are supported for older sets.</p>

        <h4>Subset / Bonus Sheet Cards</h4>
        <p>Some sets include a bonus card from a sub-set (e.g. TMNT Pizza Sheet, OTJ Breaking News). When you add a set with a known bonus sheet, the tool automatically fetches both the main set and the subset for accurate EV on bonus cards. Bonus cards appear tagged ★bonus in simulation results.</p>

        <h4>Tips</h4>
        <p>You can mix sets freely — a real-world tribal break often combines multiple sets that share a tribe (e.g. Dinosaurs across multiple sets). The Roster Summary at the bottom shows total pack count and estimated card count across all entries.</p>
      </div>
    </div>
  </div>

  <!-- What is a Tribal Break? modal -->
  <div id="tribal-modal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">
        <h3>&#x1F3B4; What is a Tribal Break?</h3>
        <button id="close-tribal-modal-btn" class="btn btn-sm">&times;</button>
      </div>
      <div class="modal-body">
        <h4>The Concept</h4>
        <p>A <strong>Tribal Break</strong> is a group buy format for opening Magic: The Gathering packs. One organizer (the "breaker") purchases a set of booster packs and sells individual spots to participants — each spot is assigned a creature tribe, card type, or other category. All rare and mythic cards that match a participant's spot go to that participant.</p>

        <h4>How Spots Work</h4>
        <p>A typical break has <strong>100 spots</strong> (or another fixed number), each named after a creature type, card type, or combination (e.g. "Dragon", "Blue Sorcery", "Equipment"). When a rare or mythic is pulled from a pack, it's assigned to whichever spot matches its primary type. If no spot matches, the card goes to the <strong>Last Spot</strong> — an unclaimed catch-all that one lucky participant holds.</p>

        <h4>Types of Breaks</h4>
        <p><strong>Random Spot</strong> — Participants pay a flat per-spot price and are randomly assigned a tribe. High variance, luck-driven.</p>
        <p><strong>Draft/Pick Break</strong> — Spots are chosen in order; popular tribes (Dragon, Elf, Wizard) cost more or are picked first. Skill-based.</p>
        <p><strong>Tribal Break</strong> — A themed break where the set selection is chosen because it features a particular tribe heavily (e.g. a Dinosaur break using Ixalan/Lost Caverns packs).</p>

        <h4>Using This Calculator</h4>
        <p>Add your packs to the <strong>Break Roster</strong>, then use <strong>Auto-Tabulate Spots</strong> to automatically assign all creature tribes and non-creature type categories. The tool calculates probability-weighted <strong>EV per spot</strong> so you can price spots fairly or evaluate whether a break is worth joining. Use <strong>Simulate Break</strong> to run a Monte Carlo simulation of a single break outcome.</p>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    <p>Data powered by <a href="https://scryfall.com" target="_blank" rel="noopener">Scryfall API</a>. Prices from TCGplayer Market.</p>
    <p>Not affiliated with Wizards of the Coast or TCGplayer.</p>
  </footer>

<script>
(function () {
  'use strict';

  var API_BASE = 'https://api.scryfall.com';
  var RATE_LIMIT_MS = 110;
  var lastRequestTime = 0;
  var sleep = function(ms) { return new Promise(function(r) { setTimeout(r, ms); }); };

  async function rateLimitedFetch(url) {
    var now = Date.now();
    var elapsed = now - lastRequestTime;
    if (elapsed < RATE_LIMIT_MS) await sleep(RATE_LIMIT_MS - elapsed);
    lastRequestTime = Date.now();
    var res = await fetch(url);
    if (!res.ok) { var err = await res.json().catch(function() { return {}; }); throw new Error(err.details || 'Scryfall API error: ' + res.status); }
    return res.json();
  }

  var allSetsCache = null, fetchPromise = null;

  async function fetchAllSets() {
    if (allSetsCache) return allSetsCache;
    if (fetchPromise) return fetchPromise;
    fetchPromise = (async function() {
      try {
        var data = await rateLimitedFetch(API_BASE + '/sets');
        var exclude = new Set(['token','memorabilia','promo','vanguard','minigame']);
        allSetsCache = data.data.filter(function(s) { return !exclude.has(s.set_type) && s.card_count > 0; }).sort(function(a,b) { return new Date(b.released_at) - new Date(a.released_at); });
        console.log('[Scryfall] Loaded', allSetsCache.length, 'sets');
        return allSetsCache;
      } catch(e) { fetchPromise = null; throw e; }
    })();
    return fetchPromise;
  }

  async function getRecentSets(count) {
    var sets = await fetchAllSets();
    var bt = new Set(['core','expansion','draft_innovation','masters','funny','box','eternal']);
    return sets.filter(function(s) { return bt.has(s.set_type); }).slice(0, count || 10);
  }

  async function searchSets(query) {
    var sets = await fetchAllSets();
    var q = query.toLowerCase().trim();
    if (!q) return [];
    return sets.filter(function(s) { return s.name.toLowerCase().includes(q) || s.code.toLowerCase() === q || s.code.toLowerCase().startsWith(q); }).slice(0, 15);
  }

  var cardCache = new Map();
  async function fetchSetCards(setCode) {
    var code = setCode.toLowerCase();
    if (cardCache.has(code)) return cardCache.get(code);
    var cards = [], url = API_BASE + '/cards/search?q=e%3A' + encodeURIComponent(code) + '&unique=prints&order=usd&dir=desc';
    while (url) {
      try { var data = await rateLimitedFetch(url); cards.push.apply(cards, data.data); url = data.has_more ? data.next_page : null; }
      catch(e) { if (e.message.includes('404')) break; throw e; }
    }
    cardCache.set(code, cards);
    console.log('[Scryfall] Cached', cards.length, 'cards for', code);
    return cards;
  }

  function getCardPrice(card, isFoil) {
    if (!card || !card.prices) return 0;
    if (isFoil) return parseFloat(card.prices.usd_foil) || parseFloat(card.prices.usd) || 0;
    return parseFloat(card.prices.usd) || 0;
  }

  function getAvailableBoosterTypes(si) {
    var t = [], rd = new Date(si.released_at);
    if (si.set_type === 'commander') return ['Draft Booster'];
    if (rd >= new Date('2024-02-01')) { t.push('Play Booster'); t.push('Collector Booster'); }
    else if (rd >= new Date('2020-09-01')) { t.push('Draft Booster'); t.push('Set Booster'); t.push('Collector Booster'); }
    else if (rd >= new Date('2019-01-01')) { t.push('Draft Booster'); t.push('Collector Booster'); }
    else { t.push('Draft Booster'); }
    return t;
  }

  // subsetChance = per-PACK probability of a bonus sheet card (applied once per pack, not per slot).
  // landFoilChance on land slots = probability that the land comes out foil (~20% in Play Boosters per WotC).
  var PP = {
    'Play Booster': { slots: [{type:'common',count:6},{type:'uncommon',count:3},{type:'rare_mythic',count:1},{type:'wildcard',count:2,weights:{common:.6,uncommon:.25,rare:.1,mythic:.05}},{type:'guaranteed_foil',count:1,weights:{common:.4,uncommon:.35,rare:.17,mythic:.08}},{type:'land',count:1,foilChance:.20}], subsetChance:.036 },
    'Draft Booster': { slots: [{type:'common',count:10},{type:'uncommon',count:3},{type:'rare_mythic',count:1},{type:'land',count:1,foilChance:.10}], subsetChance:0 },
    'Set Booster': { slots: [{type:'common',count:3},{type:'uncommon',count:3},{type:'rare_mythic',count:1},{type:'wildcard',count:2,weights:{common:.4,uncommon:.3,rare:.2,mythic:.1}},{type:'guaranteed_foil',count:1,weights:{common:.3,uncommon:.35,rare:.24,mythic:.11}},{type:'art',count:1},{type:'land',count:1,foilChance:.15}], subsetChance:.04 },
    // Collector Booster: realistic treatment-based slots.
    // Modern CBs (~2024+) typically have 15 cards with these R/M-relevant slots:
    //   1× Foil R/M (traditional foil of regular art) — 87.5/12.5 R/M split
    //   1× Non-foil Extended Art R/M — 87.5/12.5 R/M split
    //   1× Foil Extended Art R/M — 87.5/12.5 R/M split
    //   1× Non-foil Borderless/Alt-Art R/M — 80/20 R/M split (more mythic-weighted)
    //   1× Foil Borderless/Alt-Art R/M — 80/20 R/M split
    //   1× Wildcard Premium (Surge Foil, Textured, Serialized, etc.) — 92/8 R/M (very rare mythic)
    //   Plus non-R/M: 4× foil C, 2× foil U, 1× foil land, 1× art/token card
    'Collector Booster': { slots: [
      {type:'foil_common',count:4},
      {type:'foil_uncommon',count:2},
      {type:'foil_rare_mythic',count:1},
      {type:'extended_art_rare',count:1},
      {type:'foil_extended_rare',count:1},
      {type:'borderless_rare',count:1,weights:{rare:.80,mythic:.20}},
      {type:'foil_borderless_rare',count:1,weights:{rare:.80,mythic:.20}},
      {type:'wildcard_premium',count:1,weights:{rare:.92,mythic:.08}},
      {type:'foil_land',count:1}
    ], subsetChance:.15 }
  };

  // Per-set pack logic overrides. Only sets with meaningful slot-level deviations
  // from standard PP structures are listed here.
  var SET_CONFIG = {
    // MKM: 10 rare surveil dual lands occupy the Wildcard slot, NOT the R/M slot.
    // Per wildcard slot: 8.33% chance of a surveil land; 91.67% → normal wildcard.
    // ~16.67% of Play Boosters contain a surveil land across both wildcard slots.
    'mkm': {
      'Play Booster': {
        specialLandFilter: function(c) { return c.rarity==='rare' && cardHasMainType(c,'land'); },
        wildcardSpecialChance: 0.0833
      }
    },
    // OTJ: The Big Score (30 R/M-only mini-set) appears in one wildcard slot in
    // approximately 1 in 8 Play Boosters (~12.5% per pack). Breaking News bonus
    // sheet is separate (3.6% per-pack via standard subsetChance mechanism).
    'otj': {
      'Play Booster': {
        wildcardBigScoreChance: 0.125,
        bigScoreSubsetCode: 'big'
      }
    }
    // BLB, DSK, FDN, MH3: standard Play Booster structure — no overrides needed.
    // LTR (June 2023): Draft/Set/CB structure handled by date-based detection above.
  };

  function getPackCardCount(bt) { var p=PP[bt]; return p ? p.slots.reduce(function(s,sl){return s+sl.count;},0) : 0; }
  function byRarity(cards,r) { return cards.filter(function(c){return c.rarity===r;}); }
  function rPick(a) { return a.length ? a[Math.floor(Math.random()*a.length)] : null; }
  function wRarity(w) { var roll=Math.random(),c=0; for(var k in w){c+=w[k];if(roll<=c)return k;} return Object.keys(w).pop(); }

  function simPack(bt,setCards,subCards,setCode) {
    subCards=subCards||[]; var pr=PP[bt]; if(!pr)return [];
    var cfg=(SET_CONFIG[setCode||'']||{})[bt]||{};
    var C=byRarity(setCards,'common'),U=byRarity(setCards,'uncommon'),res=[];

    // Deduplicate R/M by name — each unique card gets equal probability.
    // Base printing (lowest collector #) used for standard slots.
    // Premium printing (highest price) used for CB premium/extended slots.
    var pools=buildCardPools(buildPrintingsMap(setCards));
    var R=pools.R, M=pools.M, premCards=pools.premCards;
    function premPick(c){return c?(premCards.get(c.name)||c):null;}

    // Per-set overrides
    var specialLands=[],normalR=R;
    if(cfg.specialLandFilter){
      specialLands=R.filter(cfg.specialLandFilter);
      normalR=R.filter(function(c){return !cfg.specialLandFilter(c);});
    }

    // OTJ: Big Score cards from subCards for wildcard slot injection
    var bigScoreCards=[];
    if(cfg.wildcardBigScoreChance&&cfg.bigScoreSubsetCode&&subCards.length){
      bigScoreCards=subCards.filter(function(c){return c.set&&c.set.toLowerCase()===cfg.bigScoreSubsetCode;});
      if(!bigScoreCards.length) bigScoreCards=subCards.filter(function(c){return c.rarity==='rare'||c.rarity==='mythic';});
    }

    // Bonus sheet: roll ONCE per pack, insert into first common slot
    var bonusCard=null,bonusUsed=false;
    if(subCards.length>0&&(pr.subsetChance||0)>0&&Math.random()<pr.subsetChance){
      var sC=byRarity(subCards,'common'),sU=byRarity(subCards,'uncommon'),sR=byRarity(subCards,'rare'),sM=byRarity(subCards,'mythic');
      var sr=wRarity({common:.45,uncommon:.30,rare:.20,mythic:.05});
      bonusCard=rPick(sr==='mythic'?sM:sr==='rare'?sR:sr==='uncommon'?sU:sC)||rPick(subCards);
    }

    pr.slots.forEach(function(slot){
      for(var i=0;i<slot.count;i++){
        if(bonusCard&&!bonusUsed&&slot.type==='common'){
          res.push({card:bonusCard,isFoil:false,slotType:'bonus_sheet',price:getCardPrice(bonusCard,false)});
          bonusUsed=true; continue;
        }
        var card=null,foil=false;
        switch(slot.type){
          case'common':card=rPick(C);break;case'uncommon':card=rPick(U);break;
          case'rare_mythic':card=Math.random()<.875?rPick(normalR):rPick(M);break;
          case'wildcard':{
            if(cfg.wildcardSpecialChance&&specialLands.length&&Math.random()<cfg.wildcardSpecialChance){
              card=rPick(specialLands);foil=false;
            }
            else if(cfg.wildcardBigScoreChance&&bigScoreCards.length&&Math.random()<cfg.wildcardBigScoreChance){
              card=rPick(bigScoreCards);foil=false;
            }
            else{var r=wRarity(slot.weights);card=rPick(r==='mythic'?M:r==='rare'?normalR:r==='uncommon'?U:C);}
            break;
          }
          case'guaranteed_foil':{foil=true;var r2=wRarity(slot.weights);card=rPick(r2==='mythic'?M:r2==='rare'?R:r2==='uncommon'?U:C);break;}
          case'foil_common':foil=true;card=rPick(C);break;case'foil_uncommon':foil=true;card=rPick(U);break;
          case'foil_rare_mythic':foil=true;card=Math.random()<.875?rPick(R):rPick(M);break;
          // CB premium slots: use premium printing (showcase/extended art) for pricing
          case'extended_art_rare':case'foil_extended_rare':{
            foil=slot.type.includes('foil');
            var ep=Math.random()<.875?rPick(R):rPick(M);card=premPick(ep);break;}
          case'borderless_rare':case'foil_borderless_rare':{
            foil=slot.type.includes('foil');
            var rw3=slot.weights?(slot.weights.rare||.80):.80,mw3=slot.weights?(slot.weights.mythic||.20):.20;
            var bp=Math.random()<rw3?rPick(R):rPick(M);card=premPick(bp);break;}
          case'wildcard_premium':{
            var rw4=slot.weights?(slot.weights.rare||.92):.92;
            var wp=Math.random()<rw4?rPick(R):rPick(M);card=premPick(wp);foil=true;break;}
          case'land':case'foil_land':
            card=rPick(C)||{name:'Basic Land',rarity:'common',type_line:'Basic Land',prices:{}};
            foil=slot.type==='foil_land'||(!!slot.foilChance&&Math.random()<slot.foilChance);
            break;
          case'art':card={name:'Art Card',rarity:'common',type_line:'Art Card',prices:{}};break;
          default:card=rPick(C);
        }
        if(card)res.push({card:card,isFoil:foil,slotType:slot.type,price:getCardPrice(card,foil)});
      }
    });
    return res;
  }

  function getRMDist(bt,setCards,setCode,subCards) {
    var pr=PP[bt];if(!pr)return[];
    subCards=subCards||[];
    var cfg=(SET_CONFIG[setCode||'']||{})[bt]||{};
    // Deduplicate R/M by name. Base printing (lowest collector #) used for standard slots.
    // Premium printing (highest price) used for CB premium/extended slots.
    var pools=buildCardPools(buildPrintingsMap(setCards));
    var R=pools.R, M=pools.M, premCards=pools.premCards;

    // Per-set overrides
    var specialLands=[],normalR=R;
    if(cfg.specialLandFilter){
      specialLands=R.filter(cfg.specialLandFilter);
      normalR=R.filter(function(c){return !cfg.specialLandFilter(c);});
    }

    // OTJ Big Score
    var bigScoreCards=[];
    if(cfg.wildcardBigScoreChance&&cfg.bigScoreSubsetCode&&subCards.length){
      var seenBS=new Set();
      var bsRaw=subCards.filter(function(c){return c.set&&c.set.toLowerCase()===cfg.bigScoreSubsetCode;});
      if(!bsRaw.length) bsRaw=subCards.filter(function(c){return c.rarity==='rare'||c.rarity==='mythic';});
      bigScoreCards=bsRaw.filter(function(c){
        if(seenBS.has(c.name))return false; seenBS.add(c.name); return true;
      }).filter(function(c){return c.rarity==='rare'||c.rarity==='mythic';});
    }

    var d=[];
    pr.slots.forEach(function(slot){
      var rw=0,mw=0;
      switch(slot.type){
        case'rare_mythic':case'foil_rare_mythic':rw=.875;mw=.125;break;
        case'wildcard':case'guaranteed_foil':rw=slot.weights.rare||0;mw=slot.weights.mythic||0;break;
        case'extended_art_rare':case'foil_extended_rare':rw=.875;mw=.125;break;
        case'borderless_rare':case'foil_borderless_rare':rw=slot.weights?(slot.weights.rare||.80):.80;mw=slot.weights?(slot.weights.mythic||.20):.20;break;
        case'wildcard_premium':rw=slot.weights?(slot.weights.rare||.92):.92;mw=slot.weights?(slot.weights.mythic||.08):.08;break;
        default:return;
      }
      if(rw+mw===0)return;
      var f=slot.type.includes('foil')||slot.type==='wildcard_premium';
      // CB premium/extended/borderless slots use the premium printing for pricing
      var isPrem=slot.type==='extended_art_rare'||slot.type==='foil_extended_rare'||slot.type==='wildcard_premium'||slot.type==='borderless_rare'||slot.type==='foil_borderless_rare';
      function sc(c){return isPrem&&premCards.has(c.name)?premCards.get(c.name):c;}

      if(slot.type==='rare_mythic'||slot.type==='foil_rare_mythic'){
        var rPool=specialLands.length?normalR:R;
        if(!rPool.length&&!M.length)return;
        for(var i=0;i<slot.count;i++){
          rPool.forEach(function(c){d.push({card:sc(c),probability:rw/rPool.length,isFoil:f});});
          M.forEach(function(c){d.push({card:sc(c),probability:mw/M.length,isFoil:f});});
        }
      } else if(slot.type==='wildcard'&&cfg.wildcardSpecialChance&&specialLands.length){
        var slChance=cfg.wildcardSpecialChance, normChance=1-slChance;
        for(var i=0;i<slot.count;i++){
          specialLands.forEach(function(c){d.push({card:c,probability:slChance/specialLands.length,isFoil:false});});
          if(normalR.length) normalR.forEach(function(c){d.push({card:sc(c),probability:normChance*rw/normalR.length,isFoil:f});});
          if(M.length) M.forEach(function(c){d.push({card:sc(c),probability:normChance*mw/M.length,isFoil:f});});
        }
      } else if(slot.type==='wildcard'&&cfg.wildcardBigScoreChance&&bigScoreCards.length){
        var bsChance=cfg.wildcardBigScoreChance, normChance2=1-bsChance;
        var bsR=bigScoreCards.filter(function(c){return c.rarity==='rare';});
        var bsM=bigScoreCards.filter(function(c){return c.rarity==='mythic';});
        var bsRw=bsR.length?(bsChance*0.8):0, bsMw=bsM.length?(bsChance*0.2):0;
        for(var i=0;i<slot.count;i++){
          if(bsR.length) bsR.forEach(function(c){d.push({card:c,probability:bsRw/bsR.length,isFoil:false});});
          if(bsM.length) bsM.forEach(function(c){d.push({card:c,probability:bsMw/bsM.length,isFoil:false});});
          if(R.length) R.forEach(function(c){d.push({card:sc(c),probability:normChance2*rw/R.length,isFoil:f});});
          if(M.length) M.forEach(function(c){d.push({card:sc(c),probability:normChance2*mw/M.length,isFoil:f});});
        }
      } else {
        if(!R.length&&!M.length)return;
        for(var i=0;i<slot.count;i++){
          R.forEach(function(c){d.push({card:sc(c),probability:rw/R.length,isFoil:f});});
          M.forEach(function(c){d.push({card:sc(c),probability:mw/M.length,isFoil:f});});
        }
      }
    });
    return d;
  }

  function getCardImageUrl(card) {
    if (!card) return '';
    if (card.image_uris && card.image_uris.normal) return card.image_uris.normal;
    // Double-faced cards store image_uris on each face
    if (card.card_faces && card.card_faces[0] && card.card_faces[0].image_uris) return card.card_faces[0].image_uris.normal;
    return '';
  }

  // Groups all R/M printings of a card by name, sorted by collector number (ascending).
  // Returns Map: cardName → [card, card, ...] where index 0 is the base (regular art) printing.
  function buildPrintingsMap(setCards) {
    var map = new Map();
    setCards.forEach(function(c) {
      if (c.rarity !== 'rare' && c.rarity !== 'mythic') return;
      if (!map.has(c.name)) map.set(c.name, []);
      map.get(c.name).push(c);
    });
    map.forEach(function(prints) {
      prints.sort(function(a, b) {
        return (parseInt(a.collector_number) || 9999) - (parseInt(b.collector_number) || 9999);
      });
    });
    return map;
  }

  // From a printings map, extract deduplicated R, M (base printing), and premium map.
  // Base = lowest collector number (regular art). Premium = highest-priced alternative printing.
  function buildCardPools(pMap) {
    var R = [], M = [], premCards = new Map();
    pMap.forEach(function(prints, name) {
      var base = prints[0];
      var prem = prints.length > 1 ? prints.reduce(function(best, p) {
        return getCardPrice(p, false) > getCardPrice(best, false) ? p : best;
      }, base) : base;
      if (base.rarity === 'rare') R.push(base);
      else if (base.rarity === 'mythic') M.push(base);
      if (prem !== base) premCards.set(name, prem);
    });
    return {R: R, M: M, premCards: premCards};
  }

  function extractPT(tl){if(!tl)return null;var i=tl.indexOf('\u2014');if(i===-1)return null;var s=tl.substring(i+1).trim();return s?s.split(/\s+/)[0]:null;}
  function extractAll(tl){if(!tl)return[];var i=tl.indexOf('\u2014');if(i===-1)return[];var s=tl.substring(i+1).trim();return s?s.split(/\s+/).filter(Boolean):[];}
  function parseSpotLabel(l){return l.replace(/\s+and\s+/gi,'/').replace(/\s+or\s+/gi,'/').replace(/\s*\/\s*/g,'/').split('/').map(function(s){return s.trim();}).filter(Boolean);}

  // Color helpers
  var COLOR_MAP = {W:'White',U:'Blue',B:'Black',R:'Red',G:'Green'};
  var COLOR_NAMES = {white:'W',blue:'U',black:'B',red:'R',green:'G'};
  function getCardColorKey(card) {
    var c = card.colors || [];
    if (c.length === 0) return 'Colorless';
    if (c.length > 1) return 'Multi';
    return COLOR_MAP[c[0]] || 'Colorless';
  }
  function cardHasMainType(card, typeName) {
    var tl = (card.type_line || '').toLowerCase();
    return tl.includes(typeName.toLowerCase());
  }
  function cardIsCreature(card) { return cardHasMainType(card, 'creature'); }

  // Compound match parser
  var NONCREATURE_TYPES = ['sorcery','instant','artifact','enchantment','planeswalker','battle','land'];
  var SUBTYPES_KNOWN = ['aura','equipment','saga','class','case','vehicle','food','treasure','clue','blood','map','room','curse'];
  var SUPERTYPES_KNOWN = ['legendary','basic','snow','world'];

  function parseCompoundMatch(label) {
    var parts = label.toLowerCase().trim().split(/\s+/);
    var result = {color:null, types:[], subtypes:[], supertypes:[], negate:[], raw:label};
    var negMatch = label.match(/\(([^)]+)\)/);
    if (negMatch) {
      negMatch[1].split('/').forEach(function(n) {
        var nn = n.replace(/^non-?/i,'').trim().toLowerCase();
        if (nn) result.negate.push(nn);
      });
      var cleaned = label.replace(/\([^)]*\)/g,'').trim().toLowerCase().split(/\s+/);
      parts = cleaned.filter(Boolean);
    }
    parts.forEach(function(p) {
      var pn = p.replace(/ies$/,'y').replace(/s$/,'');
      if (COLOR_NAMES[p]) { result.color = COLOR_NAMES[p]; }
      else if (p === 'multi' || p === 'multicolor' || p === 'multicolored' || p === 'gold') { result.color = 'M'; }
      else if (p === 'colorless') { result.color = 'C'; }
      else if (NONCREATURE_TYPES.indexOf(p) !== -1 || NONCREATURE_TYPES.indexOf(pn) !== -1) { result.types.push(NONCREATURE_TYPES.indexOf(p) !== -1 ? p : pn); }
      else if (SUBTYPES_KNOWN.indexOf(p) !== -1 || SUBTYPES_KNOWN.indexOf(pn) !== -1) { result.subtypes.push(SUBTYPES_KNOWN.indexOf(p) !== -1 ? p : pn); }
      else if (SUPERTYPES_KNOWN.indexOf(p) !== -1) { result.supertypes.push(p); }
      else if (p === 'other' || p === 'the' || p === 'rest' || p === 'non-creature' || p === 'not') { /* filler */ }
      else { result.subtypes.push(p); }
    });
    return result;
  }

  function cardMatchesSpot(card, mts) {
    var tl = (card.type_line || '').toLowerCase();
    var st = extractAll(card.type_line);
    var pt = extractPT(card.type_line);
    var isCr = tl.includes('creature');

    for (var j = 0; j < mts.length; j++) {
      var m = mts[j];
      var cm = parseCompoundMatch(m);
      var hasStructured = cm.types.length > 0 || cm.supertypes.length > 0 || (cm.color && cm.subtypes.length === 0);
      if (hasStructured || cm.negate.length > 0) {
        var match = true;
        if (cm.types.length > 0) {
          if (!cm.types.some(function(t) { return tl.includes(t); })) match = false;
        }
        if (match && cm.supertypes.length > 0) {
          if (!cm.supertypes.every(function(s) { return tl.includes(s); })) match = false;
        }
        if (match && cm.subtypes.length > 0) {
          if (!cm.subtypes.some(function(s) { return st.some(function(x) { return x.toLowerCase() === s; }) || tl.includes(s); })) match = false;
        }
        if (match && cm.color) {
          var cc = card.colors || [];
          if (cm.color === 'M') { if (cc.length < 2) match = false; }
          else if (cm.color === 'C') { if (cc.length > 0) match = false; }
          else { if (cc.indexOf(cm.color) === -1 || cc.length > 1) match = false; }
        }
        if (match && cm.negate.length > 0) {
          if (cm.negate.some(function(n) { return tl.includes(n); })) match = false;
        }
        if (match) return true;
      }
      var ml = m.toLowerCase();
      if (isCr && pt && pt.toLowerCase() === ml) return true;
      if (!isCr && st.some(function(s) { return s.toLowerCase() === ml; })) return true;
      if (tl.includes(ml)) return true;
    }
    return false;
  }

  function sortCards(opened,spots){
    var bulk=[],assigned=new Map(),last=[];spots.forEach(function(_,i){assigned.set(i,[]);});
    opened.forEach(function(o){
      if(o.card.rarity==='common'||o.card.rarity==='uncommon'){bulk.push(o);return;}
      for(var i=0;i<spots.length;i++){if(cardMatchesSpot(o.card,spots[i].matchTypes)){assigned.get(i).push(o);return;}}
      last.push(o);
    });
    return{bulk:bulk,assigned:assigned,lastSpot:last};
  }

  function calcEV(roster){var t=0;roster.forEach(function(e){getRMDist(e.boosterType,e.cards,e.setCode,e.subsetCards||[]).forEach(function(d){t+=getCardPrice(d.card,d.isFoil)*d.probability*e.quantity;});});return t;}

  function simBreak(roster,spots,ins){
    var all=[];roster.forEach(function(e){for(var i=0;i<e.quantity;i++){all.push.apply(all,simPack(e.boosterType,e.cards,e.subsetCards||[],e.setCode));}});
    var s=sortCards(all,spots),res=[];
    var bv=s.bulk.reduce(function(a,o){return a+o.price;},0);res.push({name:'Bulk (C/U)',cards:s.bulk,rawValue:bv,finalValue:bv,isInsured:false,isBulk:true});
    for(var i=0;i<spots.length;i++){var sc=s.assigned.get(i)||[],rv=sc.reduce(function(a,o){return a+o.price;},0),ii=rv===0&&ins>0;res.push({name:spots[i].label,cards:sc,rawValue:rv,finalValue:ii?ins:rv,isInsured:ii,isBulk:false});}
    var lv=s.lastSpot.reduce(function(a,o){return a+o.price;},0),li=lv===0&&ins>0;res.push({name:'Last Spot (Unclaimed R/M)',cards:s.lastSpot,rawValue:lv,finalValue:li?ins:lv,isInsured:li,isBulk:false,isLastSpot:true});
    var gt=res.reduce(function(a,r){return a+r.finalValue;},0);return{results:res,totalOpenedCards:all.length,grandTotal:gt,perSpot:gt/getNumSpots()};
  }

  // Breakout definitions for non-creature types
  var TYPE_BREAKOUTS = {
    'Sorcery': { test: function(c) { return cardHasMainType(c,'sorcery') && !cardIsCreature(c); },
      breakouts: [
        {label:'White Sorcery', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='W';}},
        {label:'Blue Sorcery', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='U';}},
        {label:'Black Sorcery', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='B';}},
        {label:'Red Sorcery', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='R';}},
        {label:'Green Sorcery', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='G';}},
        {label:'Multicolor Sorcery', test:function(c){return c.colors&&c.colors.length>1;}},
        {label:'Colorless Sorcery', test:function(c){return !c.colors||c.colors.length===0;}}
      ]},
    'Instant': { test: function(c) { return cardHasMainType(c,'instant') && !cardIsCreature(c); },
      breakouts: [
        {label:'White Instant', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='W';}},
        {label:'Blue Instant', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='U';}},
        {label:'Black Instant', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='B';}},
        {label:'Red Instant', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='R';}},
        {label:'Green Instant', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='G';}},
        {label:'Multicolor Instant', test:function(c){return c.colors&&c.colors.length>1;}},
        {label:'Colorless Instant', test:function(c){return !c.colors||c.colors.length===0;}}
      ]},
    'Artifact (non-Creature)': { test: function(c) { return cardHasMainType(c,'artifact') && !cardIsCreature(c); },
      breakouts: [
        {label:'Legendary Artifact', test:function(c){return cardHasMainType(c,'legendary');}},
        {label:'Equipment', test:function(c){return cardHasMainType(c,'equipment');}},
        {label:'Artifact (non-Creature/non-Equipment/non-Legendary)', test:function(c){return !cardHasMainType(c,'legendary')&&!cardHasMainType(c,'equipment');}}
      ]},
    'Enchantment (non-Creature)': { test: function(c) { return cardHasMainType(c,'enchantment') && !cardIsCreature(c); },
      breakouts: [
        {label:'Aura', test:function(c){return (c.type_line||'').toLowerCase().includes('aura');}},
        {label:'Class/Saga/Case', test:function(c){var tl=(c.type_line||'').toLowerCase();return tl.includes('class')||tl.includes('saga')||tl.includes('case');}},
        {label:'Enchantment (non-Creature/non-Aura/non-Saga/non-Class/non-Case)', test:function(c){var tl=(c.type_line||'').toLowerCase();return !tl.includes('aura')&&!tl.includes('class')&&!tl.includes('saga')&&!tl.includes('case');}}
      ]},
    'Planeswalker': { test: function(c) { return cardHasMainType(c,'planeswalker'); },
      breakouts: [
        {label:'White Planeswalker', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='W';}},
        {label:'Blue Planeswalker', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='U';}},
        {label:'Black Planeswalker', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='B';}},
        {label:'Red Planeswalker', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='R';}},
        {label:'Green Planeswalker', test:function(c){return c.colors&&c.colors.length===1&&c.colors[0]==='G';}},
        {label:'Multicolor Planeswalker', test:function(c){return c.colors&&c.colors.length>1;}},
        {label:'Colorless Planeswalker', test:function(c){return !c.colors||c.colors.length===0;}}
      ]},
    'Battle': { test: function(c) { return cardHasMainType(c,'battle'); },
      breakouts: [] },
    'Land (non-Basic)': { test: function(c) { return cardHasMainType(c,'land') && !cardHasMainType(c,'basic'); },
      breakouts: [] }
  };

  // ── Probability-weighted EV autoTab ──
  function autoTab(roster) {
    // Build per-card EV map using getRMDist (probability-weighted).
    // Stores both non-foil and foil prices so the expanded view can show both,
    // and tracks whether any foil slot contributes to this card's EV.
    // Build per-card EV map from getRMDist probability distribution.
    var cardEVMap = new Map(); // cardName -> {ev, hasFoilSlot}
    roster.forEach(function(e) {
      var dist = getRMDist(e.boosterType, e.cards, e.setCode, e.subsetCards||[]);
      dist.forEach(function(d) {
        var price = getCardPrice(d.card, d.isFoil);
        var ev = price * d.probability * e.quantity;
        var key = d.card.name;
        if (!cardEVMap.has(key)) {
          cardEVMap.set(key, {ev: 0, hasFoilSlot: false});
        }
        var entry = cardEVMap.get(key);
        entry.ev += ev;
        if (d.isFoil) entry.hasFoilSlot = true;
      });
    });

    // Build printings map for multi-art display: cardName → [{card, num, price, ...}]
    var allPrintingsMap = new Map();
    roster.forEach(function(e) {
      var pMap = buildPrintingsMap(e.cards);
      pMap.forEach(function(prints, name) {
        if (!allPrintingsMap.has(name)) allPrintingsMap.set(name, []);
        var existing = allPrintingsMap.get(name);
        prints.forEach(function(p) {
          if (!existing.some(function(x) { return x.collector_number === p.collector_number && x.set === p.set; })) {
            existing.push(p);
          }
        });
      });
    });
    // Sort each group by collector number
    allPrintingsMap.forEach(function(prints) {
      prints.sort(function(a, b) {
        return (parseInt(a.collector_number) || 9999) - (parseInt(b.collector_number) || 9999);
      });
    });

    // Collect unique R/M cards using base printing (lowest collector #)
    var seen = new Set();
    var uniqueRM = [];
    allPrintingsMap.forEach(function(prints, name) {
      if (!seen.has(name)) { seen.add(name); uniqueRM.push(prints[0]); }
    });

    // Helper to get card detail with EV, printings, and foil info
    function cardDetail(c) {
      var entry = cardEVMap.get(c.name);
      var prints = allPrintingsMap.get(c.name) || [c];
      var base = prints[0];
      return {
        name: c.name, rarity: c.rarity,
        printings: prints.map(function(p) {
          return {
            card: p,
            num: p.collector_number || '?',
            price: getCardPrice(p, false),
            foilPrice: getCardPrice(p, true),
            imageUrl: getCardImageUrl(p),
            sfUrl: p.scryfall_uri || ''
          };
        }),
        price: getCardPrice(base, false),
        foilPrice: getCardPrice(base, true),
        hasFoilSlot: entry ? entry.hasFoilSlot : false,
        ev: entry ? entry.ev : 0,
        card: base
      };
    }

    // 1) Creature subtypes
    var creatureTypes = new Map();
    uniqueRM.forEach(function(c) {
      if (!cardIsCreature(c)) return;
      var pt = extractPT(c.type_line);
      if (!pt) return;
      if (!creatureTypes.has(pt)) creatureTypes.set(pt, []);
      creatureTypes.get(pt).push(cardDetail(c));
    });

    var creatureResults = Array.from(creatureTypes.entries()).map(function(p) {
      var cards = p[1].sort(function(a,b) { return b.ev - a.ev; });
      var totalEV = cards.reduce(function(a,c) { return a + c.ev; }, 0);
      return {name: p[0], count: cards.length, totalEV: totalEV, cards: cards, category: 'Creature'};
    }).sort(function(a,b) { return b.totalEV - a.totalEV; });

    // 2) Non-creature type categories
    var typeCategories = [];
    Object.keys(TYPE_BREAKOUTS).forEach(function(catName) {
      var catDef = TYPE_BREAKOUTS[catName];
      var matching = uniqueRM.filter(catDef.test);
      if (matching.length === 0) return;

      var catCards = matching.map(cardDetail).sort(function(a,b) { return b.ev - a.ev; });
      var catTotalEV = catCards.reduce(function(a,c) { return a + c.ev; }, 0);

      var breakoutData = [];
      catDef.breakouts.forEach(function(bo) {
        var boMatching = matching.filter(bo.test);
        if (boMatching.length === 0) return;
        var boCards = boMatching.map(cardDetail).sort(function(a,b) { return b.ev - a.ev; });
        var boEV = boCards.reduce(function(a,c) { return a + c.ev; }, 0);
        breakoutData.push({label: bo.label, count: boCards.length, totalEV: boEV, cards: boCards});
      });

      typeCategories.push({
        name: catName, count: matching.length, totalEV: catTotalEV,
        cards: catCards, category: 'Type', breakouts: breakoutData
      });
    });

    typeCategories.sort(function(a,b) { return b.totalEV - a.totalEV; });
    return {creatures: creatureResults, types: typeCategories};
  }

  // ── UI ──
  var state={roster:[],spots:[],mode:'quick',selectedSet:null,setsLoaded:false,nrid:1,nsid:1};
  function $(id){return document.getElementById(id);}
  var D={rq:$('roster-qty'),rs:$('roster-set'),rp:$('roster-pack'),ab:$('add-roster-btn'),sg:$('set-suggestions'),tb:$('roster-tbody'),re:$('roster-empty'),tp:$('total-packs'),tc:$('total-cards-est'),qb:$('quick-mode-btn'),mb:$('manual-mode-btn'),qp:$('quick-mode-panel'),mp:$('manual-mode-panel'),at:$('auto-tabulate-btn'),qr:$('quick-results'),sn:$('spot-name'),asb:$('add-spot-btn'),me:$('mass-entry'),pm:$('parse-mass-btn'),sl:$('spots-list'),sc:$('spots-count'),pi:$('pack-insurance'),ns:$('num-spots'),scl:$('spot-count-label'),psl:$('per-spot-label'),ce:$('calc-ev-btn'),sb:$('simulate-btn'),gd:$('global-ev-display'),te:$('total-ev'),ps:$('per-spot-ev'),sr:$('sim-results'),sg2:$('sim-spots-grid'),lo:$('loading-overlay'),lt:$('loading-text'),tc2:$('toast-container')};
  function getNumSpots(){return Math.max(2,parseInt(D.ns.value)||100);}
  function syncSpotLabel(){var n=getNumSpots();D.scl.textContent=n;D.psl.textContent='EV Per Spot (\u00F7'+n+')';D.sc.textContent='Spots defined: '+state.spots.length+' / '+(n-1);}
  D.ns.addEventListener('change',function(){syncSpotLabel();renderSpots();});

  function toast(m,t){t=t||'info';var e=document.createElement('div');e.className='toast toast-'+t;e.textContent=m;D.tc2.appendChild(e);setTimeout(function(){e.remove();},4000);}
  function showL(t){D.lt.textContent=t||'Loading...';D.lo.classList.remove('hidden');}
  function hideL(){D.lo.classList.add('hidden');}
  function fmt(v){return '$'+(v||0).toFixed(2);}
  function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
  function debounce(fn,ms){var t;return function(){clearTimeout(t);t=setTimeout(fn,ms);};}
  function updBtn(){var h=state.roster.length>0,a=state.roster.every(function(r){return r.status==='cached';});D.at.disabled=!h||!a;D.ce.disabled=!h||!a;D.sb.disabled=!h||!a;}

  // Help tips and modals
  function openModal(id) { $(id).classList.remove('hidden'); }
  function closeModal(id) { $(id).classList.add('hidden'); }
  function wireModal(overlayId, closeBtnId) {
    $(closeBtnId).addEventListener('click', function() { closeModal(overlayId); });
    $(overlayId).addEventListener('click', function(e) { if (e.target === $(overlayId)) closeModal(overlayId); });
  }
  $('roster-help-tip').addEventListener('click', function() { openModal('roster-modal'); });
  $('methodology-btn').addEventListener('click', function() { openModal('methodology-modal'); });
  $('what-is-tribal-btn').addEventListener('click', function() { openModal('tribal-modal'); });
  wireModal('methodology-modal', 'close-modal-btn');
  wireModal('roster-modal', 'close-roster-modal-btn');
  wireModal('tribal-modal', 'close-tribal-modal-btn');

  // Autocomplete
  var sVis=false,aIdx=-1,cSug=[],bTmr=null;

  async function showDef(){
    if(!state.setsLoaded){try{showL('Loading set catalog from Scryfall...');await fetchAllSets();state.setsLoaded=true;hideL();toast('Set catalog loaded','success');}catch(e){hideL();toast('Could not reach Scryfall. Check connection.','error');return;}}
    try{var r=await getRecentSets(10);renderSug(r);}catch(e){console.error(e);}
  }

  async function handleInput(){
    var q=D.rs.value.trim();state.selectedSet=null;D.rp.innerHTML='<option value="">Select a set first</option>';D.rp.disabled=true;D.ab.disabled=true;
    if(!q){await showDef();return;}
    try{var r=await searchSets(q);renderSug(r);}catch(e){console.error(e);}
  }

  var dbInput=debounce(handleInput,150);

  function renderSug(sets){
    cSug=sets||[];aIdx=-1;D.sg.innerHTML='';
    if(!sets||!sets.length){D.sg.classList.add('hidden');sVis=false;return;}
    sets.forEach(function(s){
      var d=document.createElement('div');d.className='suggestion-item';
      d.innerHTML='<span>'+esc(s.name)+' <span class="suggestion-code">('+s.code.toLowerCase()+')</span></span>';
      d.addEventListener('mousedown',function(e){e.preventDefault();selSet(s);});
      D.sg.appendChild(d);
    });
    D.sg.classList.remove('hidden');sVis=true;
  }

  function selSet(s){
    state.selectedSet={code:s.code,name:s.name,setInfo:s};
    D.rs.value=s.name+' ('+s.code.toLowerCase()+')';D.sg.classList.add('hidden');sVis=false;
    var types=getAvailableBoosterTypes(s);D.rp.innerHTML='';
    types.forEach(function(t){var o=document.createElement('option');o.value=t;o.textContent=t;D.rp.appendChild(o);});
    D.rp.disabled=false;D.ab.disabled=false;
    console.log('[Set]',s.name,'('+s.code+') Boosters:',types.join(', '));
  }

  D.rs.addEventListener('focus',function(){clearTimeout(bTmr);if(!D.rs.value.trim()||state.selectedSet){showDef();}else if(cSug.length){D.sg.classList.remove('hidden');sVis=true;}else{handleInput();}});
  D.rs.addEventListener('input',function(){state.selectedSet=null;D.rp.innerHTML='<option value="">Select a set first</option>';D.rp.disabled=true;D.ab.disabled=true;dbInput();});
  D.rs.addEventListener('blur',function(){bTmr=setTimeout(function(){D.sg.classList.add('hidden');sVis=false;},250);});
  D.rs.addEventListener('keydown',function(e){
    if(!sVis||!cSug.length)return;
    if(e.key==='ArrowDown'){e.preventDefault();aIdx=Math.min(aIdx+1,cSug.length-1);hlSug();}
    else if(e.key==='ArrowUp'){e.preventDefault();aIdx=Math.max(aIdx-1,-1);hlSug();}
    else if(e.key==='Enter'){e.preventDefault();if(aIdx>=0&&cSug[aIdx])selSet(cSug[aIdx]);}
    else if(e.key==='Escape'){D.sg.classList.add('hidden');sVis=false;}
  });
  function hlSug(){D.sg.querySelectorAll('.suggestion-item').forEach(function(el,i){if(i===aIdx){el.classList.add('active');el.scrollIntoView({block:'nearest'});}else el.classList.remove('active');});}

  // Roster
  var SUBS={'mh3':['m3c','spg'],'mkm':['mkc','spg'],'otj':['otp','big','spg'],'woe':['woc','spg'],'lci':['lcc','spg'],'dsk':['dsc','spg'],'blb':['blc','spg'],'fdn':['spg'],'one':['onc'],'mom':['moc'],'bro':['brc'],'dmu':['dmc'],'snc':['ncc'],'neo':['nec'],'vow':['voc'],'mid':['mic'],'afr':['afc'],'stx':['c21'],'khm':['khc'],'znr':['znc'],'iko':['c20'],'tdc':['spg'],'fdm':['spg']};

  D.ab.addEventListener('click',addEntry);
  async function addEntry(){
    if(!state.selectedSet){toast('Select a set first','error');return;}
    var qty=parseInt(D.rq.value)||1,bt=D.rp.value;if(!bt){toast('Select a pack type','error');return;}
    var code=state.selectedSet.code,name=state.selectedSet.name;

    // Bug fix #3: Combine duplicate set+pack entries
    var existing = state.roster.find(function(r) { return r.setCode === code && r.boosterType === bt && r.status !== 'error'; });
    if (existing) {
      existing.quantity += qty;
      renderRoster(); updSum(); updBtn();
      D.rs.value='';D.rp.innerHTML='<option value="">Select a set first</option>';D.rp.disabled=true;D.ab.disabled=true;state.selectedSet=null;
      toast('Updated ' + name + ' to ' + existing.quantity + ' packs', 'success');
      return;
    }

    var e={id:state.nrid++,setCode:code,setName:name,boosterType:bt,quantity:qty,cards:null,subsetCards:[],status:'loading'};
    state.roster.push(e);renderRoster();updSum();updBtn();
    D.rs.value='';D.rp.innerHTML='<option value="">Select a set first</option>';D.rp.disabled=true;D.ab.disabled=true;state.selectedSet=null;
    try{toast('Fetching '+name+'...','info');var cards=await fetchSetCards(code);e.cards=cards;e.status='cached';
      var subs=SUBS[code.toLowerCase()]||[];for(var i=0;i<subs.length;i++){try{var sc=await fetchSetCards(subs[i]);e.subsetCards=e.subsetCards.concat(sc);}catch(e2){}}
      toast('Loaded '+cards.length+' cards from '+name,'success');
    }catch(err){e.status='error';toast('Failed: '+err.message,'error');}
    renderRoster();updSum();updBtn();
  }

  function rmEntry(id){state.roster=state.roster.filter(function(r){return r.id!==id;});renderRoster();updSum();updBtn();}
  function renderRoster(){
    D.tb.innerHTML='';D.re.classList.toggle('hidden',state.roster.length>0);
    state.roster.forEach(function(e){
      var tr=document.createElement('tr');
      var sc=e.status==='cached'?'status-cached':e.status==='loading'?'status-loading':'status-error';
      var st=e.status==='cached'?('\u2713 '+(e.cards?e.cards.length:0)+' cards'):e.status==='loading'?'Fetching...':'Error';
      var ec=e.status==='cached'?(e.quantity*getPackCardCount(e.boosterType)):'\u2014';
      tr.innerHTML='<td>'+e.quantity+'</td><td>'+esc(e.setName)+' <span style="color:var(--text-muted)">('+e.setCode+')</span></td><td>'+e.boosterType+'</td><td>'+ec+'</td><td><span class="status-badge '+sc+'">'+st+'</span></td><td><button class="btn btn-sm btn-danger remove-btn">\u2715</button></td>';
      tr.querySelector('.remove-btn').addEventListener('click',function(){rmEntry(e.id);});D.tb.appendChild(tr);
    });
  }
  function updSum(){var tp=0,tc=0;state.roster.forEach(function(r){tp+=r.quantity;if(r.status==='cached')tc+=r.quantity*getPackCardCount(r.boosterType);});D.tp.textContent='Total Packs: '+tp;D.tc.textContent='Est. Cards: '+tc;}

  // Modes
  D.qb.addEventListener('click',function(){state.mode='quick';D.qb.classList.add('active');D.mb.classList.remove('active');D.qp.classList.remove('hidden');D.mp.classList.add('hidden');updBtn();});
  D.mb.addEventListener('click',function(){state.mode='manual';D.mb.classList.add('active');D.qb.classList.remove('active');D.mp.classList.remove('hidden');D.qp.classList.add('hidden');updBtn();});

  // Manual spots
  D.asb.addEventListener('click',function(){var l=D.sn.value.trim();if(!l)return;addSpot(l);D.sn.value='';});
  D.sn.addEventListener('keydown',function(e){if(e.key==='Enter')D.asb.click();});
  D.pm.addEventListener('click',function(){var lines=D.me.value.split('\n').map(function(l){return l.trim();}).filter(Boolean);if(!lines.length)return;lines.forEach(function(l){addSpot(l);});D.me.value='';toast('Added '+lines.length+' spots','success');});

  function addSpot(l){var mx=getNumSpots()-1;if(state.spots.length>=mx){toast('Max '+(mx)+' spots','error');return;}state.spots.push({id:state.nsid++,label:l,matchTypes:parseSpotLabel(l)});renderSpots();updBtn();}
  function rmSpot(id){state.spots=state.spots.filter(function(s){return s.id!==id;});renderSpots();updBtn();}
  function mvSpot(id,dir){var i=state.spots.findIndex(function(s){return s.id===id;});if(i===-1)return;var n=i+dir;if(n<0||n>=state.spots.length)return;var t=state.spots[i];state.spots[i]=state.spots[n];state.spots[n]=t;renderSpots();}
  function renderSpots(){
    D.sl.innerHTML='';D.sc.textContent='Spots defined: '+state.spots.length+' / '+(getNumSpots()-1);
    state.spots.forEach(function(sp,i){
      var d=document.createElement('div');d.className='spot-item';d.setAttribute('draggable','true');d.dataset.id=sp.id;
      d.innerHTML='<span class="spot-number">#'+(i+1)+'</span><span class="spot-label">'+esc(sp.label)+'</span><span class="spot-ev">\u2014</span><div class="spot-actions"><button class="btn btn-sm move-up">\u2191</button><button class="btn btn-sm move-down">\u2193</button><button class="btn btn-sm btn-danger remove-spot">\u2715</button></div>';
      d.querySelector('.move-up').addEventListener('click',function(){mvSpot(sp.id,-1);});
      d.querySelector('.move-down').addEventListener('click',function(){mvSpot(sp.id,1);});
      d.querySelector('.remove-spot').addEventListener('click',function(){rmSpot(sp.id);});
      d.addEventListener('dragstart',function(e){e.dataTransfer.setData('text/plain',sp.id);d.style.opacity='0.5';});
      d.addEventListener('dragend',function(){d.style.opacity='1';});
      d.addEventListener('dragover',function(e){e.preventDefault();d.classList.add('drag-over');});
      d.addEventListener('dragleave',function(){d.classList.remove('drag-over');});
      d.addEventListener('drop',function(e){e.preventDefault();d.classList.remove('drag-over');var did=parseInt(e.dataTransfer.getData('text/plain'));var fi=state.spots.findIndex(function(s){return s.id===did;});var ti=state.spots.findIndex(function(s){return s.id===sp.id;});if(fi!==-1&&ti!==-1&&fi!==ti){var mv=state.spots.splice(fi,1)[0];state.spots.splice(ti,0,mv);renderSpots();}});
      D.sl.appendChild(d);
    });
  }

  // ── Render expandable type row ──
  function renderTypeRow(item, container, options) {
    options = options || {};
    var label = item.name || item.label || '(unknown)';
    var count = item.count || 0;
    var ev = item.totalEV || 0;

    var row = document.createElement('div');
    row.className = 'type-row' + (options.isBreakout ? ' breakout-row' : '');

    var header = document.createElement('div');
    header.className = 'type-row-header';
    header.innerHTML = '<span class="type-row-toggle">&#9654;</span>' +
      '<span class="type-row-name" style="color:#e6edf3">' + esc(label) + '</span>' +
      '<span class="type-row-count" style="color:#8b949e">' + count + ' card' + (count !== 1 ? 's' : '') + '</span>' +
      '<span class="type-row-ev" style="color:#3fb950">' + fmt(ev) + ' EV</span>';

    if (options.showAddBtn) {
      var addBtn = document.createElement('button');
      addBtn.className = 'btn btn-sm btn-primary';
      addBtn.textContent = '+ Spot';
      addBtn.title = 'Add as spot';
      addBtn.style.marginLeft = '0.5rem';
      addBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var lbl = item.name || item.label;
        if (state.spots.length >= getNumSpots()-1) { toast('Max '+(getNumSpots()-1)+' spots reached','error'); return; }
        if (state.spots.some(function(s) { return s.label === lbl; })) { toast(lbl + ' already added','info'); return; }
        state.spots.push({id: state.nsid++, label: lbl, matchTypes: parseSpotLabel(lbl)});
        addBtn.disabled = true; addBtn.style.opacity = '0.4';
        toast('Added: ' + lbl, 'success');
        updBtn();
      });
      header.appendChild(addBtn);
    }

    header.addEventListener('click', function() { row.classList.toggle('expanded'); });

    var cardsDiv = document.createElement('div');
    cardsDiv.className = 'type-row-cards';
    var cardHtml = '<div style="display:flex;gap:0.5rem;padding:0.25rem 0;font-size:0.7rem;color:var(--text-muted);border-bottom:1px solid var(--border)">' +
      '<span style="flex:1">Card Name</span><span style="min-width:50px">Rarity</span><span style="min-width:110px;text-align:right">Prices (per print)</span><span style="min-width:65px;text-align:right">Spot EV</span></div>';
    (item.cards || []).forEach(function(c) {
      var rc = c.rarity === 'mythic' ? 'r-mythic' : 'r-rare';

      // Build price column: show each printing's price as a hoverable span.
      // Hovering a price shows that printing's art. Title shows collector #.
      var priceHtml = '';
      if (c.printings && c.printings.length > 1) {
        priceHtml = c.printings.map(function(p) {
          var pStr = p.price > 0 ? fmt(p.price) : '\u2014';
          var imgAttr = p.imageUrl ? ' data-img="' + p.imageUrl + '"' : '';
          return '<span class="card-print-price" title="#' + esc(String(p.num)) + '"' + imgAttr + '>' + pStr + '</span>';
        }).join('<span style="color:var(--text-muted);font-size:0.75em"> / </span>');
        if (c.hasFoilSlot) {
          priceHtml += '<span style="color:#f0c040;font-size:0.7em">&nbsp;\u2728</span>';
        }
      } else {
        priceHtml = fmt(c.price);
        var hasFoil = c.hasFoilSlot && c.foilPrice > 0;
        var foilDiffers = hasFoil && Math.abs(c.foilPrice - c.price) > 0.005;
        if (hasFoil) {
          priceHtml += foilDiffers
            ? '<span style="color:#f0c040;font-size:0.7em"> /&nbsp;\u2728' + fmt(c.foilPrice) + '</span>'
            : '<span style="color:#f0c040;font-size:0.7em">&nbsp;\u2728</span>';
        }
      }

      // Card name: Scryfall link for base printing + hover image
      var imgUrl = getCardImageUrl(c.card);
      var sfUrl = (c.card && c.card.scryfall_uri) ? c.card.scryfall_uri : 'https://scryfall.com/search?q=!' + encodeURIComponent('"' + c.name + '"');
      var imgAttr = imgUrl ? ' data-img="' + imgUrl + '"' : '';
      var nameHtml = '<a href="' + sfUrl + '" target="_blank" rel="noopener" class="card-name-link"' + imgAttr + '>' + esc(c.name) + '</a>';
      cardHtml += '<div class="card-detail-row">' +
        '<span class="card-detail-name">' + nameHtml + '</span>' +
        '<span class="card-detail-rarity ' + rc + '">' + c.rarity + '</span>' +
        '<span class="card-detail-price">' + priceHtml + '</span>' +
        '<span class="card-detail-ev">' + fmt(c.ev) + '</span></div>';
    });
    cardsDiv.innerHTML = cardHtml;

    row.appendChild(header);
    row.appendChild(cardsDiv);
    container.appendChild(row);
  }

  // Quick/EV/Sim
  D.at.addEventListener('click',function(){
    if(!state.roster.length||!state.roster.every(function(r){return r.status==='cached';}))return;
    showL('Analyzing tribes & types...');setTimeout(function(){
      try{
        var rd = state.roster.map(function(r){return{setCode:r.setCode,boosterType:r.boosterType,quantity:r.quantity,cards:r.cards,subsetCards:r.subsetCards};});
        var result = autoTab(rd);

        // Auto-assign creature spots
        state.spots = result.creatures.slice(0,getNumSpots()-1).map(function(r){return{id:state.nsid++,label:r.name,matchTypes:[r.name]};});

        D.qr.classList.remove('hidden');
        D.qr.innerHTML = '';

        // ── Creature Types Section ──
        if (result.creatures.length > 0) {
          var crSec = document.createElement('div');
          crSec.className = 'cat-section';
          crSec.innerHTML = '<div class="cat-section-header"><span class="cat-section-title">Creature Types</span><span class="cat-section-badge">' + result.creatures.length + ' found &bull; auto-assigned as spots</span></div>';
          // FIX: overflow-y and flex MUST be on separate elements.
          // Putting both on the same div causes a Safari/Chrome bug where
          // flex children collapse to zero height.
          var crScroll = document.createElement('div');
          crScroll.style.cssText = 'max-height:420px;overflow-y:auto';
          var crList = document.createElement('div');
          crList.style.cssText = 'display:flex;flex-direction:column;gap:0.25rem';
          result.creatures.forEach(function(cr) { renderTypeRow(cr, crList, {showAddBtn: false}); });
          crScroll.appendChild(crList);
          crSec.appendChild(crScroll);
          D.qr.appendChild(crSec);
        } else {
          var noCreatures = document.createElement('p');
          noCreatures.style.cssText = 'color:var(--warning);padding:0.5rem';
          noCreatures.textContent = 'No creature types found in rare/mythic cards.';
          D.qr.appendChild(noCreatures);
        }

        // ── Non-Creature Types Section ──
        if (result.types.length > 0) {
          var ncSec = document.createElement('div');
          ncSec.className = 'cat-section';
          ncSec.style.marginTop = '1rem';
          ncSec.innerHTML = '<div class="cat-section-header"><span class="cat-section-title">Non-Creature Types</span><span class="cat-section-badge">click + Spot to add breakouts</span></div>';
          var ncList = document.createElement('div');
          ncList.style.cssText = 'display:flex;flex-direction:column;gap:0.25rem';

          result.types.forEach(function(cat) {
            renderTypeRow(cat, ncList, {showAddBtn: true});
            if (cat.breakouts && cat.breakouts.length > 0) {
              cat.breakouts.forEach(function(bo) {
                renderTypeRow(bo, ncList, {isBreakout: true, showAddBtn: true});
              });
            }
          });

          ncSec.appendChild(ncList);
          D.qr.appendChild(ncSec);
        }

        // Summary
        var sumP = document.createElement('p');
        sumP.style.cssText = 'margin-top:0.75rem;color:var(--text-muted);font-size:0.8rem';
        sumP.textContent = state.spots.length + ' creature spots auto-assigned. Click + Spot on non-creature breakouts to add more. Remaining R/M \u2192 Last Spot. C/U \u2192 Bulk.';
        D.qr.appendChild(sumP);

        toast('Found ' + result.creatures.length + ' creature types + ' + result.types.length + ' non-creature categories', 'success');
        updBtn();
      } catch(e) { toast('Error: '+e.message,'error'); console.error(e); }
      hideL();
    },50);
  });

  D.ce.addEventListener('click',function(){if(!state.roster.length)return;showL('Calculating EV...');setTimeout(function(){try{var rd=state.roster.map(function(r){return{setCode:r.setCode,boosterType:r.boosterType,quantity:r.quantity,cards:r.cards,subsetCards:r.subsetCards};});var ev=calcEV(rd);D.te.textContent=fmt(ev);D.ps.textContent=fmt(ev/getNumSpots());syncSpotLabel();D.gd.classList.remove('hidden');toast('EV calculated','success');}catch(e){toast('Error: '+e.message,'error');}hideL();},50);});

  D.sb.addEventListener('click',function(){if(!state.roster.length)return;if(!state.spots.length&&state.mode==='quick'){D.at.click();setTimeout(doSim,300);return;}doSim();});
  function doSim(){showL('Simulating...');setTimeout(function(){try{var rd=state.roster.map(function(r){return{setCode:r.setCode,boosterType:r.boosterType,quantity:r.quantity,cards:r.cards,subsetCards:r.subsetCards};});var ins=parseFloat(D.pi.value)||0;var sim=simBreak(rd,state.spots,ins);renderSim(sim);toast(sim.totalOpenedCards+' cards opened!','success');}catch(e){toast('Error: '+e.message,'error');console.error(e);}hideL();},100);}

  function renderSim(sim){
    D.sr.classList.remove('hidden');D.sg2.innerHTML='';
    sim.results.slice().sort(function(a,b){if(a.isBulk)return 1;if(b.isBulk)return-1;return b.finalValue-a.finalValue;}).forEach(function(spot){
      var c=document.createElement('div');c.className='sim-spot-card';
      var vc=spot.isInsured?'sim-spot-value insured':'sim-spot-value';
      var h='<div class="sim-spot-header"><span class="sim-spot-name">'+esc(spot.name)+'</span><span class="'+vc+'">'+fmt(spot.finalValue)+(spot.isInsured?' (ins)':'')+'</span></div>';
      h+='<div class="sim-spot-cards">';
      spot.cards.slice().sort(function(a,b){return b.price-a.price;}).slice(0,20).forEach(function(x){
        // Get image for the exact pulled card (which may be premium/alternate printing)
        var imgUrl=(x.card.image_uris&&x.card.image_uris.normal)||(x.card.card_faces&&x.card.card_faces[0]&&x.card.card_faces[0].image_uris&&x.card.card_faces[0].image_uris.normal)||'';
        var sfUrl=x.card.scryfall_uri||'';
        var fTag=x.isFoil?'<span style="color:#f0c040;font-size:0.65em;margin-left:3px">\u2728foil</span>':'';
        var bTag=x.slotType==='bonus_sheet'?'<span style="color:#a371f7;font-size:0.65em;margin-left:3px">\u2605bonus</span>':'';
        var nameHtml=imgUrl
          ? '<a class="card-name-link" href="'+esc(sfUrl)+'" target="_blank" rel="noopener" data-img="'+esc(imgUrl)+'">'+esc(x.card.name)+'</a>'
          : esc(x.card.name);
        h+='<span class="sim-card-chip rarity-'+x.card.rarity+'">'+nameHtml+fTag+bTag+' <span class="sim-card-price">'+fmt(x.price)+'</span></span>';
      });
      if(spot.cards.length>20)h+='<span class="sim-card-chip">+'+(spot.cards.length-20)+' more</span>';
      h+='</div>';
      c.innerHTML=h;D.sg2.appendChild(c);
    });
    D.te.textContent=fmt(sim.grandTotal);D.ps.textContent=fmt(sim.perSpot);D.gd.classList.remove('hidden');
  }

  // ── Card hover preview ──
  (function() {
    var popup = document.getElementById('card-preview-popup');
    var previewImg = document.getElementById('card-preview-img');
    var activeLink = null;

    function findHoverable(e) {
      if (!e.target.closest) return null;
      return e.target.closest('.card-name-link[data-img]') || e.target.closest('.card-print-price[data-img]');
    }

    document.addEventListener('mouseover', function(e) {
      var link = findHoverable(e);
      if (link) {
        activeLink = link;
        previewImg.src = link.dataset.img;
        popup.style.display = 'block';
      }
    });

    document.addEventListener('mouseout', function(e) {
      var link = findHoverable(e);
      if (link && link === activeLink) {
        popup.style.display = 'none';
        activeLink = null;
      }
    });

    document.addEventListener('mousemove', function(e) {
      if (popup.style.display === 'none') return;
      var imgW = 250, imgH = 350;
      var x = e.clientX + 18, y = e.clientY - 80;
      // Keep popup within viewport
      if (x + imgW > window.innerWidth)  x = e.clientX - imgW - 10;
      if (y + imgH > window.innerHeight) y = window.innerHeight - imgH - 10;
      if (y < 8) y = 8;
      if (x < 8) x = 8;
      popup.style.left = x + 'px';
      popup.style.top  = y + 'px';
    });
  })();

  // Init
  (async function(){
    console.log('[MTG Break Calc] Init...');
    try{showL('Loading set catalog from Scryfall...');await fetchAllSets();state.setsLoaded=true;hideL();toast('Set catalog loaded \u2014 click the Set field to start','success');}
    catch(e){hideL();toast('Failed to load sets. Click Set field to retry.','error');console.error(e);}
  })();

})();
</script>
</body>
</html>
